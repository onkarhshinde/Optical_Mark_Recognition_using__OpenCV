<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Entry/Exit Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/128/14649/14649052.png">
  <style>
    html {
      scroll-behavior: smooth;
     }
 
    
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #c8e3e9;
      padding-top: 2rem;
    }
    .chart-card {
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
    }
    canvas {
      background: #f7f7f7;
      border-radius: 8px;
    }
    h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
    }
    table {
      width: 100%;
    }
    thead {
      background-color: #f1f1f1;
    }

    .outside-number {
      font-size: 10rem; /* You can change this to 3rem, 5rem, etc. */
      font-weight: 700;
      text-align: center;
      color: #dc3545; /* Bootstrap's red color */
      background-color: #f8d7da;
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }


    label {
      font-weight: 500;
      }
  
      select.form-select {
      display: inline-block;
      width: auto;
      min-width: 150px;
      }
  
      .table th, .table td {
      vertical-align: middle;
      }
  
      footer {
      font-size: 0.9rem;
      }
  
      .navbar-brand {
      font-size: 1.3rem;
      }
  
      .nav-link {
        font-size: 1rem;
        }
    
        .custom-navbar {
  background-color: #4491b4 !important; /* Change to any HEX or RGB */
  height: 70px; /* or any height you prefer */
  padding-top: 20px;  /* optional: for better vertical alignment */
  padding-bottom: 20px;
}

.custom-navbar .navbar-brand, 
.custom-navbar .nav-link {
  color: #000 !important; /* Black text */
  line-height: 40px;
}
    
  </style>
</head>
<body>


  <!-- <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top shadow-sm"> -->
    <nav class="navbar navbar-expand-lg custom-navbar fixed-top shadow-sm">

    <div class="container">
      <a class="navbar-brand fw-bold" href="#">üéì Student Dashboard</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link active" href="#lineChartPrevDay">Overview</a></li>
          <li class="nav-item"><a class="nav-link" href="#avgTimeChart">Avg Time</a></li>
          <li class="nav-item"><a class="nav-link" href="#entryCountChart">Entry Count</a></li>
          <!-- <li class="nav-item"><a class="nav-link" href="#hourLineChart">Hour-wise Entries</a></li> -->
          <li class="nav-item"><a class="nav-link" href="#hourwiseCategoryChart">Hour-wise by Category</a></li>
          <li class="nav-item"><a class="nav-link" href="#heatmapChart">Heatmap</a></li>
          <li class="nav-item"><a class="nav-link" href="#lastEntriesTable">Recent</a></li>
          <li class="nav-item"><a class="nav-link" href="\form">üì≤ Device Registration</a></li>
          <li class="nav-item"><a class="nav-link" href="\student_form">üßë‚Äçüéì Student Registration</a></li>
        </ul>
      </div>
    </div>
    <script>
        document.querySelectorAll('a.nav-link[href^="#"]').forEach(anchor => {
          anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            const offset = 200; // height of your navbar
            const bodyRect = document.body.getBoundingClientRect().top;
            const elementRect = target.getBoundingClientRect().top;
            const elementPosition = elementRect - bodyRect;
            const offsetPosition = elementPosition - offset;
        
            window.scrollTo({
              top: offsetPosition,
              behavior: 'smooth'
            });
          });
        });
        </script>
        
  </nav>






<div class="container">
  <h1 class="text-center mb-5"> </h1>

  <div class="row">
    <div class="col-md-6">
      <div class="chart-card">
        <h2>Past 7 Days: Entries & Exits</h2>
        <canvas id="barChart7days"></canvas>
      </div>
    </div>
    <div class="col-md-6">
      <div class="chart-card">
        <h2>Previous Day Hourly: Entries & Exits</h2>
        <canvas id="lineChartPrevDay"></canvas>
      </div>
    </div>


    <div class="col-12">
      <div class="chart-card">
        <h2>Past 30 Days Average Time Spent (by Category)</h2>
        <div class="mb-3">
          <label for="categorySelect" class="form-label">Select Category:</label>
          <select id="categorySelect" class="form-select w-auto">
            <option value="year">Year</option>
            <option value="gender">Gender</option>
            <option value="stream">Stream</option>
            <option value="branch">Branch</option>
            <option value="hostel">Hostel</option>
          </select>
        </div>
        <canvas id="avgTimeChart"></canvas>
      </div>
    </div>
    <div class="row row-equal">
      <!-- Left: PIE CHART -->
      <div class="col-md-6">
        <div class="chart-card h-100">
          <h2>Number of Entries (Past 30 Days)</h2>
          <div class="mb-3">
            <label for="entryCategorySelect" class="form-label">Select Category:</label>
            <select id="entryCategorySelect" class="form-select w-auto">
              <option value="year">Year</option>
              <option value="gender">Gender</option>
              <option value="stream">Stream</option>
              <option value="branch">Branch</option>
              <option value="hostel">Hostel</option>
            </select>
          </div>
          <canvas id="entryCountChart"></canvas>
        </div>
      </div>
    
      <!-- Right: LINE CHART + OUTSIDE STUDENTS BAR -->
      <div class="col-md-6">
        <div class="right-column-content h-100">
          <div class="chart-card">
            <h2>Hour-wise Entries (Past 30 Days)</h2>
            <canvas id="hourLineChart"></canvas>
          </div>
          <div class="chart-card">
            <h2>Number of Students Outside Campus</h2>
            <div class="text-center" style="font-size: 5rem; font-weight: bold;" id="outsideCount" class="outside-number"></div>
          </div>
        </div>
      </div>
    </div>
    
    
    



    <div class="col-12">
      <div class="chart-card">
        <h2>Hour-wise Entries (Past 30 Days) by Category</h2>
        <div class="mb-3">
          <label for="hourCategorySelect" class="form-label">Select Category:</label>
          <select id="hourCategorySelect" class="form-select w-auto">
            <option value="year">Year</option>
            <option value="gender">Gender</option>
            <option value="stream">Stream</option>
            <option value="branch">Branch</option>
            <option value="hostel">Hostel</option>
          </select>
        </div>
        <canvas id="hourwiseCategoryChart"></canvas>
      </div>
    </div>



    <div class="col-12">
      <div class="chart-card">
        <h2>Heatmap: Weekday vs. Hour</h2>
        <canvas id="heatmapChart"></canvas>
      </div>
    </div>

    <div class="col-12">
      <div class="chart-card">
        <h2>Last 5 Entries</h2>
        <table class="table table-striped table-hover table-bordered">
          <thead>
            <tr>
              <th>Roll No</th>
              <th>Exit Time</th>
              <th>Entry Time</th>
              <th>Duration (mins)</th>
            </tr>
          </thead>
          <tbody id="lastEntriesTable"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
fetch('/data')
  .then(response => response.json())
  .then(data => {
    const dates7 = data.entries7days.map(item => item.date);
    const entries7 = data.entries7days.map(item => item.num_entries);
    const exitMap = {};
    data.exits7days.forEach(item => exitMap[item.date] = item.num_exits);
    const exits7 = dates7.map(date => exitMap[date] || 0);

    new Chart(document.getElementById('barChart7days').getContext('2d'), {
      type: 'bar',
      data: {
        labels: dates7,
        datasets: [
          { label: 'Entries', backgroundColor: 'rgba(54, 162, 235, 0.7)', data: entries7 },
          { label: 'Exits', backgroundColor: 'rgba(255, 99, 132, 0.7)', data: exits7 }
        ]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    const hoursPrev = data.prevdayEntries.map(item => item.hr);
    const prevEntries = data.prevdayEntries.map(item => item.num_entries);
    const exitPrevMap = {};
    data.prevdayExits.forEach(item => exitPrevMap[item.hr] = item.num_exits);
    const prevExits = hoursPrev.map(hr => exitPrevMap[hr] || 0);

    new Chart(document.getElementById('lineChartPrevDay').getContext('2d'), {
      type: 'line',
      data: {
        labels: hoursPrev,
        datasets: [
          { label: 'Entries', borderColor: 'rgba(54, 162, 235, 1)', fill: false, data: prevEntries },
          { label: 'Exits', borderColor: 'rgba(255, 99, 132, 1)', fill: false, data: prevExits }
        ]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    const categorySelect = document.getElementById('categorySelect');
    const avgTimeCtx = document.getElementById('avgTimeChart').getContext('2d');
    let avgChart;

    function updateAvgTimeChart(category) {
      const catData = data.avgTimeByCategory[category];
      const labels = catData.map(item => item.category);
      const values = catData.map(item => item.avg_duration);
      const chartData = {
        labels,
        datasets: [{
          label: `Avg Duration by ${category}`,
          backgroundColor: 'rgba(75, 192, 192, 0.7)',
          data: values
        }]
      };

      if (avgChart) {
        avgChart.data = chartData;
        avgChart.update();
      } else {
        avgChart = new Chart(avgTimeCtx, {
          type: 'bar',
          data: chartData,
          options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
      }
    }
    updateAvgTimeChart(categorySelect.value);
    categorySelect.addEventListener('change', () => updateAvgTimeChart(categorySelect.value));

    // PIE CHART FOR ENTRY COUNT
    const entryCategorySelect = document.getElementById('entryCategorySelect');
    const entryCountCtx = document.getElementById('entryCountChart').getContext('2d');
    let entryChart;

    function updateEntryChart(category) {
      const catData = data.entryCountByCategory[category];
      const labels = catData.map(item => item.category);
      const values = catData.map(item => item.count);
      const colors = labels.map((_, i) => `hsl(${i * 50}, 70%, 60%)`);

      const chartData = {
        labels,
        datasets: [{
          label: `Entries by ${category}`,
          backgroundColor: colors,
          data: values
        }]
      };

      if (entryChart) {
        entryChart.data = chartData;
        entryChart.update();
      } else {
        entryChart = new Chart(entryCountCtx, {
          type: 'pie',
          data: chartData,
          options: { responsive: true }
        });
      }
    }
    updateEntryChart(entryCategorySelect.value);
    entryCategorySelect.addEventListener('change', () => updateEntryChart(entryCategorySelect.value));

    const hourCategorySelect = document.getElementById('hourCategorySelect');
    const hourCatCtx = document.getElementById('hourwiseCategoryChart').getContext('2d');
    let hourCatChart;

    function updateHourwiseCategoryChart(category) {
      const raw = data.hourwiseCategoryEntries[category];
      const grouped = {};
      raw.forEach(item => {
        if (!grouped[item.category]) grouped[item.category] = Array(24).fill(0);
        grouped[item.category][item.hr] = item.count;
      });

      const datasets = Object.entries(grouped).map(([label, data], i) => ({
        label,
        data,
        fill: false,
        borderColor: `hsl(${i * 50}, 70%, 50%)`
      }));

      const chartData = {
        labels: Array.from({ length: 24 }, (_, i) => i),
        datasets
      };

      if (hourCatChart) {
        hourCatChart.data = chartData;
        hourCatChart.update();
      } else {
        hourCatChart = new Chart(hourCatCtx, {
          type: 'line',
          data: chartData,
          options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
      }
    }
    updateHourwiseCategoryChart(hourCategorySelect.value);
    hourCategorySelect.addEventListener('change', () => updateHourwiseCategoryChart(hourCategorySelect.value));


    new Chart(document.getElementById('hourLineChart').getContext('2d'), {
      type: 'line',
      data: {
        labels: data.hourwiseEntries.map(i => i.hr),
        datasets: [{
          label: 'Entries (Past 30 Days)',
          data: data.hourwiseEntries.map(i => i.num_entries),
          borderColor: 'rgba(153, 102, 255, 1)',
          fill: false
        }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    let heatmapMatrix = Array.from({ length: 7 }, () => Array(24).fill(0));
    data.heatmapData.forEach(item => {
      heatmapMatrix[item.weekday - 1][item.hr] = item.count;
    });

    const heatmapPoints = [];
    for (let i = 0; i < 7; i++) {
      for (let j = 0; j < 24; j++) {
        heatmapPoints.push({ x: j, y: weekdays[i], r: Math.max(5, heatmapMatrix[i][j]) });
      }
    }

    new Chart(document.getElementById('heatmapChart').getContext('2d'), {
      type: 'bubble',
      data: {
        datasets: [{
          label: 'Entries Heatmap',
          data: heatmapPoints,
          backgroundColor: 'rgba(255, 159, 64, 0.7)'
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { title: { display: true, text: 'Hour of Day' }, ticks: { stepSize: 1 } },
          y: { title: { display: true, text: 'Weekday' }, type: 'category', labels: weekdays }
        }
      }
    });

    const tableBody = document.getElementById('lastEntriesTable');
    data.lastEntries.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.rollno}</td>
        <td>${item.exit_datetime}</td>
        <td>${item.entry_datetime}</td>
        <td>${item.duration}</td>
      `;
      tableBody.appendChild(tr);
    });


    document.getElementById('outsideCount').textContent = data.outsideStudentsCount;

    
  });

  


</script>



<footer class="bg-dark text-white text-center py-3 mt-5">
  <div>  | ¬© 2025 Student Exit-Entry System | </div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


</body>
</html>
